package gitlab

import (
	"fmt"
	"strings"

	cidsdk "github.com/cidverse/cid-sdk-go"
	"github.com/cidverse/cidverseutils/pkg/cihelper"
)

type PublishAction struct {
	Sdk cidsdk.SDKClient
}

type PublishConfig struct {
	GitLabToken string `json:"gitlab_token"  env:"GITLAB_TOKEN"`
}

func (a PublishAction) Execute() (err error) {
	cfg := PublishConfig{}
	ctx, err := a.Sdk.ProjectAction(&cfg)
	if err != nil {
		return err
	}

	// changelog
	changelogFile := cidsdk.JoinPath(ctx.Config.TempDir, "github.changelog")
	downloadChangelogErr := a.Sdk.ArtifactDownload(cidsdk.ArtifactDownloadRequest{
		ID:         "root|changelog|github.changelog",
		TargetFile: changelogFile,
	})

	// support for self-hosted instances
	host, err := cihelper.GetHostFromGitRemote(ctx.Env["NCI_REPOSITORY_REMOTE"])
	if err != nil {
		return err
	}

	// tls self-signed ca
	if strings.HasSuffix(host, ".local") {
		_, err = a.Sdk.ExecuteCommand(cidsdk.ExecuteCommandRequest{
			Command: fmt.Sprintf(`glab config set skip_tls_verify true --host %q`, host),
			WorkDir: ctx.ProjectDir,
		})
		if err != nil {
			return err
		}
	}

	// token
	glToken := ctx.Env["GITLAB_TOKEN"]
	if botToken, ok := ctx.Env["GITLAB_BOT_TOKEN"]; ok {
		glToken = botToken
	}

	// options
	var releaseOpts []string
	if downloadChangelogErr == nil { // use changelog generated by pipeline, default to GitHub auto generated release notes if not available
		releaseOpts = append(releaseOpts, fmt.Sprintf("-F %s", changelogFile))
	} else {
		releaseOpts = append(releaseOpts, fmt.Sprintf("--notes %q", "no release notes"))
	}

	// create release
	_ = a.Sdk.Log(cidsdk.LogMessageRequest{Level: "info", Message: "creating gitlab release", Context: map[string]interface{}{"host": host, "name": ctx.Env["NCI_COMMIT_REF_NAME"]}})
	releaseResult, err := a.Sdk.ExecuteCommand(cidsdk.ExecuteCommandRequest{
		Command: fmt.Sprintf(`glab release create %q %s`, ctx.Env["NCI_COMMIT_REF_NAME"], strings.Join(releaseOpts, " ")),
		WorkDir: ctx.ProjectDir,
		Env: map[string]string{
			"GITLAB_HOST":     host,
			"GITLAB_API_HOST": host,
			"GITLAB_TOKEN":    glToken,
		},
	})
	if err != nil {
		return err
	} else if releaseResult.Code != 0 {
		return fmt.Errorf("gitlab release creation failed, exit code %d", releaseResult.Code)
	}

	return nil
}
